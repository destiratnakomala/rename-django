{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Manipulate Data</h2>

    <form method="post" id="manipulate-form" enctype="multipart/form-data" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div class="mb-3">
            <label class="form-label">Select CSV Files to Manipulate:</label>
            <div class="form-check">
                {% for file in uploaded_files %}
                    <input class="form-check-input" type="checkbox" name="files" value="{{ file }}" id="file_{{ forloop.counter }}" onchange="updateColumns()" required>
                    <label class="form-check-label" for="file_{{ forloop.counter }}">
                        {{ file }}
                    </label>
                {% endfor %}
            </div>
            <div class="invalid-feedback">
                Please select at least one file.
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Join Column:</label>
            <select id="join-column" name="join_column" class="form-select" required>
                <option value="">Select a column</option>
                {% for column in common_columns %}
                    <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>
            <div class="invalid-feedback">
                Please select a join column.
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Manipulate</button>
    </form>

    <!-- Ensure this block is only shown when there's manipulated data -->
    {% if manipulated_result %}
        <h3 class="mt-4">Manipulated Result:</h3>
        <div class="table-responsive">
            <div class="table-container">
                {{ manipulated_result|safe }}  <!-- Render the DataFrame HTML table safely -->
            </div>
        </div>
    {% endif %}
</div>

<script>
    function updateColumns() {
        // Fetch selected files
        const selectedFiles = Array.from(document.querySelectorAll('input[name="files"]:checked')).map(input => input.value);

        // Make AJAX call to fetch common columns
        fetch('{% url "get_common_columns" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ files: selectedFiles })
        })
        .then(response => response.json())
        .then(data => {
            const joinColumnSelect = document.getElementById('join-column');
            joinColumnSelect.innerHTML = '<option value="">Select a column</option>';  // Clear existing options

            // Populate the join column dropdown with common columns
            data.common_columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                joinColumnSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error:', error));
    }

    // Enable Bootstrap validation styles
    (function () {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })()
</script>

{% endblock %}
